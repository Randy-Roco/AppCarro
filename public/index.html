<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AppCarro ‚Äî Proyectos, KMZ y C√°lculo por Colimaci√≥n</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Librer√≠as para KMZ (ZIP) + reproyecci√≥n UTM->WGS84 -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="logo">
        <span class="logo-dot"></span>
      </div>
      <div>
        <h1>AppCarro</h1>
        <p class="subtitle">Geom√°tica ‚Ä¢ Proyectos ‚Ä¢ Calibraci√≥n por colimaci√≥n ‚Ä¢ KMZ ‚Ä¢ Export GIS</p>
      </div>
    </div>

    <div class="header-actions">
      <!-- Proyectos -->
      <div class="proj-bar">
        <label class="sr-only" for="selProject">Proyecto</label>
        <select id="selProject" class="select select-compact" title="Proyecto activo"></select>

        <button id="btnNewProject" class="btn btn-secondary" title="Crear nuevo proyecto">
          <span class="btn-ico">Ôºã</span> Nuevo
        </button>

        <button id="btnSaveProject" class="btn btn-secondary" title="Guardar cambios del proyecto activo">
          <span class="btn-ico">üíæ</span> Guardar
        </button>

        <button id="btnExportProject" class="btn btn-ghost" title="Exportar proyecto (.json)">
          <span class="btn-ico">‚¨á</span> Proyecto
        </button>

        <input id="fileImportProject" type="file" accept=".json" style="display:none;" />
        <button id="btnImportProject" class="btn btn-ghost" title="Importar proyecto (.json)">
          <span class="btn-ico">‚¨Ü</span> Importar
        </button>
      </div>

      <div class="header-sep"></div>

      <!-- Calibraci√≥n / Config -->
      <button id="btnCalibrate" class="btn btn-secondary">
        <span class="btn-ico">‚ü≥</span> Recalibrar
      </button>

      <button id="btnOpenConfig" class="btn btn-ghost">
        <span class="btn-ico">‚öô</span> Config
      </button>
    </div>
  </header>

  <main class="grid">
    <!-- Panel izquierdo -->
    <section class="card">
      <div class="card-title">
        <h2>Estado de calibraci√≥n</h2>
        <span class="badge" id="badgeStatus">Cargando‚Ä¶</span>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Ajuste horizontal (ŒîAH)</div>
          <div class="kpi-value" id="kpiAh">‚Äî</div>
          <div class="kpi-help">Offset de azimut aplicado a observados.</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Ajuste vertical (ŒîAV)</div>
          <div class="kpi-value" id="kpiAv">‚Äî</div>
          <div class="kpi-help">Offset de inclinaci√≥n aplicado a observados.</div>
        </div>
      </div>

      <div class="mini">
        <div class="mini-title">C√°mara (fija desde config)</div>
        <div class="mini-grid" id="cameraBox"></div>
      </div>

      <div class="mini">
        <div class="mini-title">Diagn√≥stico colimaci√≥n</div>
        <div class="hint">Revisa residuales por punto (ŒîAH/ŒîAV) para detectar outliers.</div>
        <div class="table-wrap">
          <table class="table" id="diagTable">
            <thead>
              <tr>
                <th>Punto</th>
                <th>ŒîAH (¬∞)</th>
                <th>ŒîAV (¬∞)</th>
                <th>Res Dist (m)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="mini">
        <div class="mini-title">Export GIS</div>
        <div class="hint">GeoJSON se importa directo en QGIS/ArcGIS (coordenadas UTM EPSG:32719 por defecto).</div>
        <div class="row">
          <button id="btnExportGeoJSON" class="btn btn-secondary">
            <span class="btn-ico">üó∫Ô∏è</span> Exportar GeoJSON
          </button>
          <button id="btnExportCSV" class="btn btn-ghost" title="Exporta CSV separado por el separador seleccionado">
            <span class="btn-ico">üìÑ</span> Exportar CSV
          </button>
        </div>
      </div>
    </section>

    <!-- Panel derecho -->
    <section class="card">
      <div class="card-title">
        <h2>C√°lculo de nuevos puntos</h2>
        <div class="card-actions">
          <button id="btnAddPoint" class="btn btn-primary">
            <span class="btn-ico">Ôºã</span> Calcular y agregar
          </button>
          <button id="btnExport" class="btn btn-secondary">
            <span class="btn-ico">‚¨á</span> Exportar TXT
          </button>
          <button id="btnClear" class="btn btn-ghost">
            <span class="btn-ico">üßπ</span> Limpiar
          </button>
        </div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>√Ångulo Horizontal observado (¬∞)</label>
          <input id="inAh" type="text" placeholder="Ej: 311.87" />
          <small>Convenci√≥n: 0¬∞=Norte, 90¬∞=Este</small>
        </div>

        <div class="field">
          <label>√Ångulo Vertical observado (¬∞)</label>
          <input id="inAv" type="text" placeholder="Ej: -1.80" />
          <small>Inclinaci√≥n respecto a la horizontal</small>
        </div>

        <div class="field">
          <label>Distancia observada (m)</label>
          <input id="inD" type="text" placeholder="Ej: 6725" />
          <small>Distancia inclinada</small>
        </div>

        <div class="field">
          <label>Separador exportaci√≥n</label>
          <select id="selSep">
            <option value=";">Punto y coma (;) ‚Äî Excel</option>
            <option value=",">Coma (,)</option>
            <option value="\t">Tab (TSV)</option>
          </select>
        </div>

        <div class="field">
          <label>Decimal exportaci√≥n</label>
          <select id="selDec">
            <option value=".">Punto (.)</option>
            <option value=",">Coma (,)</option>
          </select>
        </div>

        <div class="field">
          <label>Nombre de archivo</label>
          <input id="inFile" type="text" placeholder="puntos_calculados.txt" />
        </div>
      </div>

      <div class="table-wrap">
        <table class="table" id="pointsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>X (Este)</th>
              <th>Y (Norte)</th>
              <th>Z</th>
              <th>AHc</th>
              <th>AVc</th>
              <th>D</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer-note">
        <img class="file-ico" src="assets/txt.png" alt="txt" />
        <span>Exporta un TXT con cabecera + puntos calculados. Ideal para reporte o carga GIS.</span>
      </div>

      <!-- MAPA -->
      <div class="mini" style="margin-top:14px;">
        <div class="card-title" style="margin-bottom:10px;">
          <h2>Mapa (KMZ / Imagen / Extents)</h2>
          <div class="card-actions">
            <input id="fileKmz" type="file" accept=".kmz" style="display:none;" />
            <button id="btnLoadKmz" class="btn btn-secondary" title="Cargar KMZ con GroundOverlay">
              <span class="btn-ico">üó∫Ô∏è</span> Cargar KMZ
            </button>

            <input id="fileImg" type="file" accept="image/*" style="display:none;" />
            <button id="btnLoadImg" class="btn btn-ghost" title="Cargar imagen de fondo (PNG/JPG)">
              <span class="btn-ico">üñºÔ∏è</span> Imagen
            </button>

            <input id="fileWld" type="file" accept=".tfw,.jgw,.pgw,.wld,.txt" style="display:none;" />
            <button id="btnLoadWld" class="btn btn-ghost" title="Cargar World File para calzar imagen">
              <span class="btn-ico">üìê</span> World file
            </button>

            <label class="sr-only" for="selCrs">CRS</label>
            <select id="selCrs" class="select select-compact" title="Sistema de coordenadas de los puntos">
              <option value="EPSG:32719" selected>EPSG:32719 (UTM 19S)</option>
              <option value="EPSG:32718">EPSG:32718 (UTM 18S)</option>
              <option value="EPSG:4326">EPSG:4326 (Lat/Lon)</option>
            </select>

            <button id="btnFitMap" class="btn btn-ghost" title="Ajustar vista a puntos">
              <span class="btn-ico">‚§¢</span> Fit
            </button>
          </div>
        </div>

        <div class="hint">
          KMZ se interpreta como <b>GroundOverlay</b> en WGS84. Tus puntos est√°n en <b>UTM 19S (EPSG:32719)</b>.
          Sin mapa cargado, la vista usa extents de los puntos.
        </div>

        <div class="table-wrap" style="max-height:none;">
          <canvas id="mapCanvas" width="1400" height="520" style="width:100%; height:auto; display:block;"></canvas>
        </div>

        <div class="footer-note" style="margin-top:10px;">
          <img class="file-ico" src="assets/xml.png" alt="kmz" />
          <span>Tip: exporta el overlay como KMZ (una imagen + KML con LatLonBox). Para imagen georreferenciada, usa World File (TFW/PGW/JGW).</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Config -->
  <div class="modal" id="modalConfig" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3>Config fija (c√°mara + colimaci√≥n)</h3>
        <button class="btn btn-ghost" id="btnCloseConfig">‚úï</button>
      </div>
      <p class="hint">Edita el JSON y guarda. Se recalibrar√° autom√°ticamente (se guarda en el proyecto activo).</p>

      <textarea id="configEditor" spellcheck="false"></textarea>

      <div class="modal-actions">
        <button id="btnSaveConfig" class="btn btn-primary">Guardar Config</button>
        <button id="btnReloadConfig" class="btn btn-secondary">Recargar</button>
      </div>
    </div>
  </div>

  <!-- Modal Proyecto -->
  <div class="modal" id="modalProject" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card" style="max-width:720px;">
      <div class="modal-head">
        <h3>Proyecto</h3>
        <button class="btn btn-ghost" id="btnCloseProject">‚úï</button>
      </div>

      <div style="padding:14px;">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div class="field">
            <label>Nombre del proyecto</label>
            <input id="inProjectName" type="text" placeholder="Ej: Laguna MEL ‚Äî 2026-01-22" />
            <small>Se guarda localmente en tu navegador (y puedes exportarlo a JSON).</small>
          </div>

          <div class="field">
            <label>Acciones</label>
            <div class="row" style="gap:10px; margin-top:2px;">
              <button id="btnDuplicateProject" class="btn btn-secondary">Duplicar</button>
              <button id="btnDeleteProject" class="btn btn-ghost" title="Elimina el proyecto activo">Eliminar</button>
            </div>
            <small>Tip: Duplica para campa√±as futuras manteniendo colimaci√≥n/c√°mara.</small>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="btnSaveProjectName" class="btn btn-primary">Guardar</button>
        <button id="btnCancelProject" class="btn btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="app.js"></script>
</body>
</html>
